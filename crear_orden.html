<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Crear Orden | MC Terminals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
  body {
    background-color: #0e0e2c;
    color: white;
    font-family: 'Segoe UI', sans-serif;
  }
  .card {
    position: relative;
    background-color: #1b1b3a;
    border-radius: 15px;
    box-shadow: 0 0 20px #3f3f91;
    margin-top: 50px;
    padding: 20px;
  }
  .form-label { color: white; font-weight: bold; }
  input, select, textarea { background-color: #2c2c4a; color: white; border: none; }
  input::placeholder, textarea::placeholder { color: #aaa; }
  .logo-superior { position: absolute; top: 15px; right: 20px; }
  .logo-img { width: 100px; height: auto; }
  .ayuda-placa { color: #fff; }
  @media (max-width: 768px) {
    .logo-superior { top: 10px; right: 10px; }
    .logo-img { width: 80px; }
    h3.text-white { font-size: 1.3rem; text-align: center; }
    .row .col-md-6 { width: 100%; }
    .form-label { font-size: 0.9rem; }
    .btn { width: 100%; }
  }
  </style>
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
</head>
<body>
  <div class="container">
    <div class="card p-4">
      <div class="logo-superior">
        <img src="https://fpqnzqrdyxmhptosplos.supabase.co/storage/v1/object/public/logos//logo_1.png" alt="Logo MC" class="logo-img">
      </div>
      <h3 class="text-center mb-4 text-white">Crear Nueva Orden</h3>

      <form id="ordenForm">
        <div class="mb-3">
          <label class="form-label">Fecha de carga (opcional)</label>
          <input type="date" class="form-control" id="fecha_programada">
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Bodega</label>
            <select class="form-select" id="bodega" required>
              <option value="">Seleccione...</option>
              <option value="MC Terminals Puerto Barrios">Puerto Barrios</option>
              <option value="MC Terminals Puerto Quetzal">Puerto Quetzal</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nombre del Buque</label>
            <select class="form-select" id="buque" required>
              <option value="">Seleccione un buque...</option>
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Poliza</label>
            <select class="form-select" id="bl" required>
              <option value="">Seleccione una poliza...</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Producto</label>
            <select class="form-select" id="producto" required>
              <option value="">Seleccione un producto...</option>
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Piloto</label>
            <input type="text" class="form-control" id="piloto" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Placa</label>
            <div class="input-group">
              <span class="input-group-text">C-</span>
              <input type="text" class="form-control" id="placa" placeholder="123ABC" maxlength="6" autocomplete="off" required>
            </div>
            <small class="ayuda-placa">Ingrese 3 números y 3 letras. Ejemplo: 123ABC (el sistema agrega C-).</small>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Tipo de Unidad</label>
            <select class="form-select" id="tipo_unidad" required>
              <option value="">Seleccione...</option>
              <option value="varanda">Varanda</option>
              <option value="granelera">Granelera</option>
              <option value="gondola">Góndola</option>
              <option value="volteo">Volteo</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Cantidad (qq)</label>
            <input type="number" class="form-control" id="cantidad_qq" required min="1" step="0.0001" inputmode="decimal">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Nombre del Transporte</label>
            <input type="text" class="form-control" id="nombre_transporte" placeholder="Ej. TRANSPORTE A GRANEL">
          </div>
          <div class="col-md-6">
            <label class="form-label">No. de Orden Interna</label>
            <input type="text" class="form-control" id="orden_interna" placeholder="Ej. ORD-2024-AZ55">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Observación</label>
          <textarea class="form-control" id="observacion" rows="2"></textarea>
        </div>

        <button type="submit" class="btn btn-success w-100">Crear Orden</button>
        <div id="mensaje" class="text-center mt-3 text-white"></div>
        <button type="button" class="btn btn-primary w-100 mt-2" onclick="window.location.href='ingreso_masivo.html'">Ingreso Masivo</button>
      </form>
    </div>
  </div>

  <div class="text-center mt-4">
    <button class="btn btn-outline-light" onclick="window.location.href='menu.html'">Regresar al Menú</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabase = window.supabase.createClient(
      'https://fpqnzqrdyxmhptosplos.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwcW56cXJkeXhtaHB0b3NwbG9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3NjMyNDYsImV4cCI6MjA2MzMzOTI0Nn0.tcz7BdDovKPS-KoPk_LxRJW8ZfJpgjN8fKQ7h6NdR6c'
    );

    const form = document.getElementById("ordenForm");
    const mensaje = document.getElementById("mensaje");

    const blSelect = document.getElementById("bl");
    const productoSelect = document.getElementById("producto");

    blSelect.addEventListener("mousedown", (e) => {
      const buque = document.getElementById("buque").value;
      if (!buque) {
        e.preventDefault();
        mensaje.innerText = "⚠️ Primero debes seleccionar un buque.";
        mensaje.style.color = "orange";
      }
    });

    productoSelect.addEventListener("mousedown", (e) => {
      const bl = document.getElementById("bl").value;
      if (!bl) {
        e.preventDefault();
        mensaje.innerText = "⚠️ Primero debes seleccionar una poliza.";
        mensaje.style.color = "orange";
      }
    });

    function parseCantidadQQ(v) {
      if (v == null || v === "") return { ok: false, error: "Cantidad vacía" };
      let s = String(v).trim().replace(/\s/g, "");
      const hasDot = s.includes(".");
      const hasComma = s.includes(",");
      if (hasDot && hasComma) {
        const lastDot = s.lastIndexOf(".");
        const lastComma = s.lastIndexOf(",");
        if (lastComma > lastDot) s = s.replace(/\./g, "").replace(",", ".");
        else s = s.replace(/,/g, "");
      } else if (hasComma && !hasDot) {
        s = s.replace(",", ".");
      }
      const n = parseFloat(s);
      if (!isFinite(n)) return { ok: false, error: "Cantidad inválida" };
      if (n < 1) return { ok: false, error: "La cantidad debe ser ≥ 1" };
      return { ok: true, valor: Number(n.toFixed(4)) };
    }

    // === Helpers de fecha/hora en Guatemala (UTC-06:00) ===
    function isoAhoraGuatemala() {
      const tz = "America/Guatemala";
      const s = new Intl.DateTimeFormat("sv-SE", {
        timeZone: tz,
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit",
        hour12:false
      }).format(new Date()); // "YYYY-MM-DD HH:mm:ss"
      return s.replace(" ", "T") + "-06:00";
    }
    function hoyGuatemalaYYYYMMDD() {
      const tz = "America/Guatemala";
      const s = new Intl.DateTimeFormat("sv-SE", {
        timeZone: tz, year:"numeric", month:"2-digit", day:"2-digit"
      }).format(new Date());
      return s.split(" ")[0];
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nombre_transporte = document.getElementById("nombre_transporte").value.trim();
      const no_orden_interna = document.getElementById("orden_interna").value.trim();

      // Validación de fecha programada (no pasada). NO se usa para el reloj de 24h.
      const inputFecha = document.getElementById("fecha_programada").value;
      if (inputFecha) {
        const hoyGT = hoyGuatemalaYYYYMMDD();
        if (inputFecha < hoyGT) {
          mensaje.innerText = "⚠️ No se permiten fechas pasadas.";
          mensaje.style.color = "orange";
          return;
        }
      }

      // Fechas para control 24h (ahora en Guatemala)
      const fecha_generada = isoAhoraGuatemala();
      const fecha_creada   = isoAhoraGuatemala();

      const nit_usuario = localStorage.getItem("nit");
      const piloto = document.getElementById("piloto").value.trim();
      const placaRaw = document.getElementById("placa").value.trim().toUpperCase();
      if (!/^\d{3}[A-Z]{3}$/.test(placaRaw)) {
        mensaje.innerText = "Placa inválida. Debe escribir 3 números seguidos de 3 letras, por ejemplo: 123ABC. El sistema agregará C- automáticamente.";
        mensaje.style.color = "orange";
        return;
      }
      const placa = `C-${placaRaw}`;

      const tipo_unidad = document.getElementById("tipo_unidad").value;
      const producto = document.getElementById("producto").value;
      const bodega = document.getElementById("bodega").value;

      const cantRes = parseCantidadQQ(document.getElementById("cantidad_qq").value);
      if (!cantRes.ok) {
        mensaje.innerText = `⚠️ ${cantRes.error}`;
        mensaje.style.color = "orange";
        return;
      }
      const cantidad_qq = cantRes.valor;
      // ⛔ NO calcular ni enviar cantidad_ton: es columna generada en la DB

      const buque = document.getElementById("buque").value.trim();
      const bl = document.getElementById("bl").value.trim();
      const observacion = document.getElementById("observacion").value.trim();

      if (!piloto || !placa || !tipo_unidad || !producto || !bodega || !buque || !bl) {
        mensaje.innerText = "Por favor llena todos los campos requeridos.";
        mensaje.style.color = "orange";
        return;
      }
      if (!nit_usuario) {
        mensaje.innerText = "Error: Usuario no autenticado.";
        return;
      }

      const payload = {
        nit_usuario,
        piloto,
        placa,
        tipo_unidad,
        producto,
        bodega,
        cantidad_qq,           // ✅ Solo esto; la DB calculará cantidad_ton
        buque,
        bl,
        nombre_transporte,
        no_orden_interna,
        observacion,
        fecha_generada,
        fecha_creada
      };

      const { error } = await supabase.from("ordenes").insert([payload]);

      if (error) {
        console.error("Error al crear orden:", error);
        mensaje.innerText = "No se pudo crear la orden.";
      } else {
        mensaje.style.color = "lightgreen";
        mensaje.innerText = "¡Orden creada exitosamente!";
        setTimeout(() => { window.location.href = "menu.html"; }, 2000);
      }
    });
  </script>

  <script>
    const rol = localStorage.getItem("rol");
    const nit_usuario = localStorage.getItem("nit");
    let todosBLs = [];

    document.addEventListener("DOMContentLoaded", async () => {
      await cargarBuques();
      document.getElementById("buque").addEventListener("change", mostrarBLsDelBuque);
      document.getElementById("bl").addEventListener("change", mostrarProductoDelBL);
    });

    async function cargarBuques() {
      const selectBuque = document.getElementById("buque");
      const blSelect = document.getElementById("bl");
      const productoSelect = document.getElementById("producto");

      selectBuque.innerHTML = `<option value="">Seleccione un buque...</option>`;
      blSelect.innerHTML = `<option value="">Seleccione una poliza...</option>`;
      productoSelect.innerHTML = `<option value="">Seleccione un producto...</option>`;
      selectBuque.disabled = false;
      blSelect.disabled = true;
      productoSelect.disabled = true;

      try {
        let buques = [];

        if (rol === "consignatario") {
          const { data: blsData, error: e1 } = await supabase
            .from("bls_producto")
            .select("id_producto_buque")
            .eq("nit_empresa", nit_usuario);
          if (e1) throw e1;

          const idsProducto = [...new Set((blsData || []).map(b => b.id_producto_buque))];
          if (idsProducto.length === 0) {
            selectBuque.disabled = true;
            blSelect.disabled = true;
            productoSelect.disabled = true;
            const mensaje = document.getElementById("mensaje");
            mensaje.textContent = "No tiene pólizas (BL) asignadas.";
            mensaje.style.color = "orange";
            return;
          }

          const { data: productosData, error: e2 } = await supabase
            .from("productos_buque")
            .select("id, id_buque")
            .in("id", idsProducto);
          if (e2) throw e2;

          const idsBuques = [...new Set((productosData || []).map(p => p.id_buque))];
          if (idsBuques.length === 0) {
            selectBuque.disabled = true;
            blSelect.disabled = true;
            productoSelect.disabled = true;
            const mensaje = document.getElementById("mensaje");
            mensaje.textContent = "No hay buques disponibles para sus BL.";
            mensaje.style.color = "orange";
            return;
          }

          const { data: buquesData, error: e3 } = await supabase
            .from("buques")
            .select("id, nombre")
            .in("id", idsBuques)
            .order("nombre", { ascending: true });
          if (e3) throw e3;

          buques = buquesData || [];
        } else {
          const { data, error } = await supabase
            .from("buques")
            .select("id, nombre")
            .order("nombre", { ascending: true });
          if (error) throw error;
          buques = data || [];
        }

        buques.forEach(b => {
          const opt = document.createElement("option");
          opt.value = b.id;
          opt.textContent = b.nombre;
          selectBuque.appendChild(opt);
        });

        blSelect.disabled = false;
      } catch (err) {
        console.error("Error cargando buques:", err);
        const mensaje = document.getElementById("mensaje");
        mensaje.textContent = "Error cargando buques.";
        mensaje.style.color = "orange";
      }
    }

    async function mostrarBLsDelBuque() {
      const buqueId = document.getElementById("buque").value;
      const blSelect = document.getElementById("bl");
      const productoSelect = document.getElementById("producto");

      blSelect.innerHTML = `<option value="">Seleccione una poliza...</option>`;
      productoSelect.innerHTML = `<option value="">Seleccione un producto...</option>`;
      productoSelect.disabled = true;

      if (!buqueId) {
        blSelect.disabled = true;
        return;
      }

      try {
        const { data: productos, error: eProd } = await supabase
          .from("productos_buque")
          .select("id, producto")
          .eq("id_buque", buqueId);
        if (eProd) throw eProd;

        const idsProducto = (productos || []).map(p => p.id);
        if (idsProducto.length === 0) {
          blSelect.disabled = true;
          const mensaje = document.getElementById("mensaje");
          mensaje.textContent = "Este buque no tiene productos disponibles.";
          mensaje.style.color = "orange";
          return;
        }

        let query = supabase
          .from("bls_producto")
          .select("bl, id_producto_buque, nit_empresa")
          .in("id_producto_buque", idsProducto);

        const rol = localStorage.getItem("rol");
        const nit_usuario = localStorage.getItem("nit");
        if (rol === "consignatario") {
          query = query.eq("nit_empresa", nit_usuario);
        }

        const { data: bls, error: eBL } = await query;
        if (eBL) throw eBL;

        window.todosBLs = (bls || []).map(b => ({
          bl: b.bl,
          id_producto_buque: b.id_producto_buque,
          producto: (productos.find(p => p.id === b.id_producto_buque) || {}).producto || ""
        }));

        if (rol === "consignatario" && window.todosBLs.length === 0) {
          blSelect.disabled = true;
          const mensaje = document.getElementById("mensaje");
          mensaje.textContent = "Este buque no tiene pólizas (BL) asignadas a su empresa.";
          mensaje.style.color = "orange";
          return;
        }

        blSelect.disabled = false;
        window.todosBLs.forEach(b => {
          const opt = document.createElement("option");
          opt.value = b.bl;
          opt.textContent = b.bl;
          blSelect.appendChild(opt);
        });
      } catch (err) {
        console.error("Error listando BL:", err);
        const mensaje = document.getElementById("mensaje");
        mensaje.textContent = "Error cargando pólizas.";
        mensaje.style.color = "orange";
      }
    }

    function mostrarProductoDelBL() {
      const blSeleccionado = document.getElementById("bl").value;
      const prodSelect = document.getElementById("producto");

      prodSelect.innerHTML = `<option value="">Seleccione un producto...</option>`;
      prodSelect.disabled = true;

      const producto = (window.todosBLs || []).find(b => b.bl === blSeleccionado)?.producto;
      if (producto) {
        const opt = document.createElement("option");
        opt.value = producto;
        opt.textContent = producto;
        prodSelect.appendChild(opt);
        prodSelect.value = producto;
        prodSelect.disabled = true;
      }
    }

    // Validación de placa (input)
    const placaInput = document.getElementById("placa");
    placaInput.addEventListener("input", (e) => {
      let v = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
      const numeros = v.slice(0, 3).replace(/\D/g, "");
      const letras  = v.slice(3, 6).replace(/[^A-Z]/g, "");
      e.target.value = (numeros + letras).slice(0, 6);
    });
    placaInput.addEventListener("blur", () => {
      const ok = /^\d{3}[A-Z]{3}$/.test(placaInput.value);
      const mensaje = document.getElementById("mensaje");
      if (placaInput.value && !ok) {
        mensaje.innerText = "Placa inválida. Formato requerido: C-123ABC (usted solo escribe 123ABC).";
        mensaje.style.color = "orange";
        placaInput.focus();
      } else if (ok) {
        mensaje.innerText = "";
      }
    });
  </script>

  <script>
    // Seguridad: sesión obligatoria
    if (!localStorage.getItem("nit")) {
      window.location.replace("login.html");
    }
    // Bloqueo de retroceso
    history.pushState(null, null, location.href);
    window.onpopstate = function () { history.pushState(null, null, location.href); };
  </script>
  <script src="guard_bloqueo.js"></script>
  <script src="mensajes_globales.js"></script>
</body>
</html>
