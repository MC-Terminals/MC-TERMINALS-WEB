<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin | Mensajes Globales</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root { color-scheme: dark; }
    body{ background:#0e0e2c; color:#fff; font-family:'Segoe UI',sans-serif; }
    .card{
      background:#1b1b3a; border:none; border-radius:16px;
      max-width:720px; margin:6vh auto; padding:24px; box-shadow:0 0 20px #3f3f91;
    }
    .form-control, .form-select, textarea{
      background:#2c2c4a; color:#fff; border:1px solid #3a3a5a;
    }
    .form-control:focus, .form-select:focus, textarea:focus{
      color:#fff; background:#2c2c4a; border-color:#6b7cff;
      box-shadow:0 0 0 .2rem rgba(107,124,255,.25); outline:0;
    }
    .form-control::placeholder, textarea::placeholder{ color:#e5e7eb; opacity:.9; }
    .muted, .form-text, .text-muted, small, .form-label{ color:#fff !important; opacity:.95; }
    .form-control:disabled, .form-select:disabled, textarea:disabled{
      background:#2a2a45; color:#cbd5e1; border-color:#3a3a5a; opacity:1;
    }
    .form-check-input{ background-color:#2c2c4a; border-color:#6a6a8a; }
    .form-check-input:checked{ background-color:#22c55e; border-color:#22c55e; }
    .form-check-label{ color:#fff; }
    .btn-success{ color:#fff; }
    .btn-outline-light{ color:#fff; border-color:#e5e7eb; }
    .btn-outline-light:hover{ background:#e5e7eb; color:#1b1b3a; }
    .card h1,.card h2,.card h3,.card h4,.card h5,.card h6,.h1,.h2,.h3,.h4,.h5,.h6,.card-title { color:#fff !important; }
    .heading-glow { text-shadow: 0 0 8px rgba(158,203,255,.35); }
    pre#salida { color:#fff; background:#0f0f2a; border-radius:12px; padding:12px; border:1px solid #2c2c4a; }
  </style>
</head>
<body>
  <div class="card">
    <h3 class="mb-3 heading-glow">üì¢ Administrar mensajes globales</h3>

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">T√≠tulo</label>
        <input id="titulo" class="form-control" maxlength="120" placeholder="T√≠tulo corto"/>
      </div>
      <div class="col-md-6">
        <label class="form-label">Tipo de mensaje</label>
        <div class="form-check">
          <input id="chkFijo" class="form-check-input" type="checkbox" checked/>
          <label class="form-check-label" for="chkFijo">Fijo (sin caducidad)</label>
        </div>
      </div>

      <div class="col-12">
        <label class="form-label">Mensaje</label>
        <textarea id="mensajeTexto" rows="4" class="form-control" maxlength="2000" placeholder="Texto para todos los usuarios..."></textarea>
      </div>

      <div class="col-md-4">
        <label class="form-label">Duraci√≥n (minutos, si NO es fijo)</label>
        <input id="duracion" type="number" class="form-control" value="30" min="1" max="1440"/>
        <div class="muted mt-1">Solo se aplica si <b>no</b> marcas ‚ÄúFijo‚Äù.</div>
      </div>

      <div class="col-12 d-grid gap-2 mt-2">
        <button class="btn btn-success" onclick="publicarMensaje()">Publicar</button>
      </div>
    </div>

    <hr class="my-4"/>

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">ID a cerrar (UUID)</label>
        <input id="idCerrar" type="text" class="form-control" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
      </div>
      <div class="col-md-6 d-grid gap-2 align-items-end">
        <button class="btn btn-warning" onclick="cerrarMensaje()">Cerrar mensaje</button>
        <button class="btn btn-outline-light" onclick="listarActivos()">Listar activos</button>
      </div>
    </div>

    <pre id="salida" class="mt-3" style="white-space:pre-wrap"></pre>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ‚öôÔ∏è Supabase
    const supabase = window.supabase.createClient(
      "https://fpqnzqrdyxmhptosplos.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwcW56cXJkeXhtaHB0b3NwbG9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3NjMyNDYsImV4cCI6MjA2MzMzOTI0Nn0.tcz7BdDovKPS-KoPk_LxRJW8ZfJpgjN8fKQ7h6NdR6c"
    );

    // Tomamos el NIT guardado tras el login
    const nit = (localStorage.getItem("nit") || "").trim();
    const out = (x)=> document.getElementById("salida").textContent =
      typeof x==='string' ? x : JSON.stringify(x,null,2);

    // Habilitar/deshabilitar minutos seg√∫n ‚ÄúFijo‚Äù
    const chkFijo = document.getElementById('chkFijo');
    const duracion = document.getElementById('duracion');
    const toggleDuration = ()=> duracion.disabled = chkFijo.checked;
    chkFijo.addEventListener('change', toggleDuration); toggleDuration();

    // üü¢ Publicar (via RPC: publicar_mensaje)
    async function publicarMensaje() {
      if (!nit) return out("No hay NIT en localStorage. Inicia sesi√≥n.");

      const titulo  = document.getElementById("titulo").value.trim();
      const texto   = document.getElementById("mensajeTexto").value.trim();
      const fijo    = document.getElementById("chkFijo").checked;
      const minutos = Number(document.getElementById("duracion").value || 30);

      const { data, error } = await supabase.rpc("publicar_mensaje", {
        p_titulo:  titulo,
        p_texto:   texto,
        p_fijo:    fijo,
        p_minutos: minutos,
        p_nit:     nit,
      });

      if (error) return out({ error: error.message });
      out({ ok: true, id: data });
    }

    // üü† Cerrar (via RPC: cerrar_mensaje)
    async function cerrarMensaje() {
      if (!nit) return out("No hay NIT en localStorage. Inicia sesi√≥n.");

      const id = document.getElementById("idCerrar").value.trim();
      if (!id) return out("Ingresa un UUID v√°lido.");

      const { error } = await supabase.rpc("cerrar_mensaje", { p_id: id, p_nit: nit });
      if (error) return out({ error: error.message });
      out({ ok: true });
    }

    // üìÑ Listar mensajes activos (solo lectura directa con RLS)
    async function listarActivos() {
      const { data, error } = await supabase
        .from("mensajes_globales")
        .select("*")
        .eq("activo", true)
        .order("inicio", { ascending: false });

      if (error) return out({ error: error.message });
      out(data);
    }
  </script>
</body>
</html>
