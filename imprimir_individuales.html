<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Órdenes individuales (PDF)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { font-family: Arial, sans-serif; color:#000; background:#f2f2f7; }
    .page {
      width: 100%;
      max-width: 680px; /* ancho cómodo half-letter */
      margin: 12px auto;
      padding: 12px 16px;
      border: 1px solid #000;
      background: #fff;
      page-break-after: always;
    }
    .page:last-child { page-break-after: auto; }

    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .header .empresa { font-weight:700; }
    .logo { width: 110px; }
    h2 { text-align:center; margin: 4px 0 12px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #000; padding:6px; text-align:left; font-size:12px; }
    .meta td { border:none; padding:2px 0; }

    .toolbar { position:sticky; top:0; background:#f8f9fa; padding:10px; border-bottom:1px solid #ddd; z-index: 5; }
    .status { font-size: 0.9rem; }

    @media print {
      @page { size: half-letter portrait; margin: 15mm; }
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .toolbar { display:none !important; }
      .page { border:0; margin:0; }
    }
  </style>
</head>
<body>

<div class="toolbar d-flex gap-2 justify-content-center align-items-center">
  <button class="btn btn-primary" onclick="window.print()">Imprimir</button>
  <button class="btn btn-outline-dark" onclick="location.href='menu.html'">Menú</button>
  <span id="status" class="ms-2 status text-muted"></span>
</div>

<div id="contenedor"></div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  // === CONFIG ===
  const supabase = window.supabase.createClient(
    'https://fpqnzqrdyxmhptosplos.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwcW56cXJkeXhtaHB0b3NwbG9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3NjMyNDYsImV4cCI6MjA2MzMzOTI0Nn0.tcz7BdDovKPS-KoPk_LxRJW8ZfJpgjN8fKQ7h6NdR6c'
  );
  const LOGO_URL = "https://fpqnzqrdyxmhptosplos.supabase.co/storage/v1/object/public/logos//logo_1.png";

  const fmtTon = new Intl.NumberFormat("es-GT",{ minimumFractionDigits:2, maximumFractionDigits:2 });
  const fmtQQ  = new Intl.NumberFormat("es-GT",{ minimumFractionDigits:0, maximumFractionDigits:4 });

  const $status = (t)=>{ const el=document.getElementById('status'); if(el) el.textContent=t||''; };

  function getQueryIds() {
    const p = new URLSearchParams(location.search);
    const raw = (p.get("ids") || "").trim();
    if (!raw) return [];
    return raw.split(",").map(x => Number(x)).filter(x => Number.isFinite(x));
  }

  function sanitizeForFilename(s='') {
    return String(s).normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')     // quita acentos
      .replace(/[^\w\s-]/g,'')            // quita símbolos raros
      .trim().replace(/\s+/g,'_');        // espacios -> _
  }

  async function buildAndAutoDownloadPDF(meta) {
    // Formato half-letter: 140 x 216 mm
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'mm', format: [140, 216], orientation: 'portrait' });

    const pages = Array.from(document.querySelectorAll('.page'));
    if (!pages.length) return;

    $status('Generando PDF…');

    for (let i = 0; i < pages.length; i++) {
      const node = pages[i];

      // Render a canvas
      const canvas = await html2canvas(node, { scale: 2, useCORS: true });
      const img = canvas.toDataURL('image/png');

      const w = doc.internal.pageSize.getWidth();
      const h = doc.internal.pageSize.getHeight();

      if (i > 0) doc.addPage();
      doc.addImage(img, 'PNG', 0, 0, w, h);
    }

    const fecha = new Date().toLocaleDateString('es-GT', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g,'-');
    const empresa = sanitizeForFilename(meta.empresa || 'Empresa');
    const producto = sanitizeForFilename(meta.producto || 'Producto');
    const fileName = `Ordenes_de_Carga_${empresa}_${producto}_${fecha}.pdf`;

    doc.save(fileName);
    $status('Descargado.');
  }

  async function main() {
    const ids = getQueryIds();
    if (!ids.length) {
      document.getElementById("contenedor").innerHTML =
        '<div class="alert alert-warning m-3">No se recibieron órdenes para imprimir.</div>';
      return;
    }

    // 1) Traer órdenes
    const { data: ordenes, error } = await supabase
      .from("ordenes")
      .select("*")
      .in("no_orden", ids);

    if (error) {
      console.error(error);
      document.getElementById("contenedor").innerHTML =
        '<div class="alert alert-danger m-3">Error cargando órdenes.</div>';
      return;
    }

    // 2) Mapas auxiliares: empresa por nit, nombre de buque
    const nits = [...new Set(ordenes.map(o => o.nit_usuario))];
    const { data: usuarios } = await supabase
      .from("usuarios")
      .select("nit, empresa")
      .in("nit", nits);

    const empresaPorNit = {};
    (usuarios || []).forEach(u => empresaPorNit[u.nit] = u.empresa);

    const buqueIds = [...new Set(ordenes.map(o => o.buque))];
    const { data: buques } = await supabase
      .from("buques")
      .select("id, nombre")
      .in("id", buqueIds);

    const buquePorId = {};
    (buques || []).forEach(b => buquePorId[b.id] = b.nombre);

    // 3) Pintar una página por orden
    const cont = document.getElementById("contenedor");
    cont.innerHTML = ordenes
      .sort((a,b) => a.no_orden - b.no_orden)
      .map(o => {
        const empresa = empresaPorNit[o.nit_usuario] || "Empresa Desconocida";
        const buque   = buquePorId[o.buque] || o.buque;
        const ton     = (typeof o.cantidad_ton === "number")
                        ? o.cantidad_ton
                        : (Number(o.cantidad_qq || 0) / 22.046);
        const fechaGen = o.fecha_generada ? new Date(o.fecha_generada).toLocaleString() : "";

        // importante para CORS con html2canvas
        return `
          <div class="page">
            <div class="header">
              <div class="empresa">${empresa}</div>
              <img class="logo" src="${LOGO_URL}" crossorigin="anonymous" />
            </div>
            <h2>Orden de Carga</h2>

            <table class="mb-2">
              <tr><th>No. Orden</th><td>${o.no_orden}</td></tr>
              <tr><th>Empresa</th><td>${empresa}</td></tr>
              <tr><th>Piloto</th><td>${o.piloto || ""}</td></tr>
              <tr><th>Placa</th><td>${o.placa || ""}</td></tr>
              <tr><th>Buque</th><td>${buque}</td></tr>
              <tr><th>Poliza</th><td>${o.bl || ""}</td></tr>
              <tr><th>Tipo Unidad</th><td>${o.tipo_unidad || ""}</td></tr>
              <tr><th>Producto</th><td>${o.producto || ""}</td></tr>
              <tr><th>Bodega</th><td>${o.bodega || ""}</td></tr>
              <tr><th>Cantidad (qq)</th><td>${fmtQQ.format(Number(o.cantidad_qq || 0))}</td></tr>
              <tr><th>Cantidad (ton)</th><td>${fmtTon.format(Number(ton))}</td></tr>
              <tr><th>Estatus</th><td>${o.estatus || ""}</td></tr>
              <tr><th>Nombre Transporte</th><td>${o.nombre_transporte || ""}</td></tr>
              <tr><th>No. Orden Interna</th><td>${o.no_orden_interna || ""}</td></tr>
              <tr><th>Observación</th><td>${o.observacion || ""}</td></tr>
              <tr><th>Turno</th><td>${o.turno || ""}</td></tr>
              <tr><th>Fecha Generada</th><td>${fechaGen}</td></tr>
            </table>
          </div>
        `;
      })
      .join("");

    // 4) Generar y descargar automáticamente el PDF
    //     (también queda el botón IMPRIMIR por si quieren usar el diálogo del navegador)
    const metaPrimera = {
      empresa: empresaPorNit[ordenes[0].nit_usuario] || 'Empresa',
      producto: ordenes[0].producto || 'Producto',
    };
    await buildAndAutoDownloadPDF(metaPrimera);
  }

  // Seguridad de sesión
  if (!localStorage.getItem("nit")) {
    window.location.replace("login.html");
  } else {
    main().catch(err => { console.error(err); $status('Error generando PDF'); });
  }
</script>
</body>
</html>
